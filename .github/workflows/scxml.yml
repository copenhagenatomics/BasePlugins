#builds the scxml plugins
name: scxml
on:
  workflow_call:
    inputs:
      BLOB_URL:
        required: true
        type: string
    secrets:
      BLOB_QUERYSTRING:
        required: false
      GH_TOKEN:
        required: true
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: download scxmltocode
      run: curl -o scxml/scxmltocode "https://caplugins.blob.core.windows.net/generator/scxmltocode1.9.2"
    - uses: rymndhng/release-on-push-action@aebba2bbce07a9474bf95e8710e5ee8a9e922fe2 #v0.28.0
      id: release-on-push
      if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }} # tag only pushes to the main branch
      with:
        bump_version_scheme: minor
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        
    - name: download plugins ids files to reuse existing ids#
      shell: bash +e {0}  # "+e" = don't "fail fast" since we want to check the return code of curl
      run: |
        pids=()
        for file in scxml/*.scxml
        do
          idsfile=$(basename ${file%.*}).ids
          echo downloading $idsfile
          curl -f -o scxml/$idsfile "${{inputs.BLOB_URL}}$idsfile${{secrets.BLOB_QUERYSTRING}}"&
          pids+=("$!") #store id of the background process that was just started
        done
        #check if all the background processes succeeded
        for job in "${pids[@]}"
        do
            wait $job
            returnCode=$?
            if [ "$returnCode" -eq 22 ]
            then 
              echo "idsfile not found, skipping";
            elif [ "$returnCode" -ne 0 ]
            then
              echo "An error occurred while downloading file"; 
              exit 1;
            fi
        done
    
    #-------------------
    # Handle versioning
    #-------------------
    - name: Set version
      id: setver
      shell: bash
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          version="pr${{ github.event.pull_request.number }}-${{ github.run_number }}"
        else
          version="${{ steps.release-on-push.outputs.tag_name }}"
          version="${version#v}"
          version="${version:-0.0.0}"
        fi
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "Using version: $version"

    - name: generate plugins
      run: |
        cd scxml && chmod +x ./scxmltocode && ./scxmltocode --pluginsversion "${{ steps.setver.outputs.version }}" --savesources &&
        echo "${{ steps.setver.outputs.version }}" > latestver.txt
      shell: bash
      
    - name: Zip files for release # we do this as we suspect uploading separate files count as separate requests for github APIs rate limiting
      if: always()
      run: zip -r scxml/plugins.zip scxml/*.dll scxml/*.ids scxml/*.cs

    #------------------------------------------------------
    # Release assets only for main branch pushes
    #------------------------------------------------------
    - name: Release
      if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }} # upload only pushes to the main branch
      uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 #v2.3.3
      with:
        files: scxml/plugins.zip
        tag_name: ${{ steps.release-on-push.outputs.tag_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
    
    #------------------------------------------------------
    # Upload assets only for PR pushes
    #------------------------------------------------------
    - name: Upload generated sources for PR pushes
      if: ${{ success() && github.event_name == 'pull_request' }}
      uses: actions/upload-artifact@v4
      with:
        name: generated-sources-PR
        retention-days: 1
        path: scxml/plugins.zip
        
    - name: Archive generated sources on failures
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: generated-sources
        retention-days: 3
        path: scxml/plugins.zip
        
    - name: upload plugins to blob
      if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') ||  github.event_name == 'pull_request' }}
      shell: bash
      run: |
        version="${{ steps.setver.outputs.version }}"
        pids=()
        
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "Uploading PR build artifacts..."
          # The pattern scxml/*"${version}"*.ids matches .ids files in scxml/ whose names contain the current version string.
          upload_files=(scxml/*.dll scxml/*"${version}"*.ids)
        else
          echo "Uploading main branch release artifacts..."
          upload_files=(scxml/*.dll scxml/*.ids scxml/latestver.txt)
        fi

        for file in "${upload_files[@]}";
        do
          echo uploading $file
          curl -f -X PUT -H "x-ms-version: 2020-04-08" -H "Content-Type: application/octet-stream" -H "x-ms-blob-type: BlockBlob" \
            "${{inputs.BLOB_URL}}$(basename $file)${{secrets.BLOB_QUERYSTRING}}" --upload-file "$file"&
          pids+=("$!") #store id of the background process that was just started
        done
        #check if all the background processes succeeded
        for job in "${pids[@]}"
        do
            wait $job || { echo "An error occurred while uploading plugin"; exit 1; }
        done
        
    - name: Add comment to the PR with the version
      if: ${{ github.event_name == 'pull_request' }} #success() && 
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        header: uploaded-plugins
        message: |
          âœ… **Plugins uploaded for PR build**

          **Version:** `${{ steps.setver.outputs.version }}`
